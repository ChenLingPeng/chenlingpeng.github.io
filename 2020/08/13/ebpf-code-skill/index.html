<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Developer in Tencent"><title>ebpf code skill | chenlingpeng</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ebpf code skill</h1><a id="logo" href="/.">chenlingpeng</a><p class="description">hahahaha</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ebpf code skill</h1><div class="post-meta">Aug 13, 2020</div><div class="post-content"><pre><code>本文介绍编写 ebpf 程序时可能遇到的坑或注意事项，持续更新中
</code></pre><ol start="0">
<li><p>最大的原则：不要一次性写太多代码！！！</p>
<p> 每次写少量代码后都需要编译测试，千万不要一次性写太多逻辑。否则一旦代码有问题，导致无法load到内核，非常难定位具体错在哪。ebpf的报错信息实在太坑爹，这也是为什么会有本文的原因</p>
</li>
<li><p>ntohs</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">u16 sport = skb-&gt;sport;</span><br><span class="line">sport = ntohs(sport);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误写法</span></span><br><span class="line"><span class="comment">// u16 sport = ntohs(skb-&gt;sport);</span></span><br></pre></td></tr></table></figure>
<p> 下面错误的写法在加载时会报 ‘permission deny’ 错误。</p>
</li>
<li></li>
</ol>
<p>从map中lookup出来的指针，不能直接update回去，在ebpf代码中更新值之后不再需要重新update，因为拿到了引用</p>
<ol start="3">
<li><p>struct初始化问题</p>
<p> 定义结构体</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#define SERVER_SIDE 0</span><br><span class="line">struct sock_info &#123;</span><br><span class="line">    u64 ts;</span><br><span class="line">    u32 direct:1,</span><br><span class="line">        flag1:7,</span><br><span class="line">        flag2:8,</span><br><span class="line">        flag3:16;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>
<p> 按以下方式初始化结构体会报错</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct sock_info info = &#123;</span><br><span class="line">.ts = 0,</span><br><span class="line">.direct = SERVER_SIDE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> 需要先声明 <code>u64 ts = 0</code> 然后赋值</p>
</li>
<li><p>字符串拷贝可以使用编译器内置的 <code>__builtin_memcpy</code></p>
</li>
<li><p>关于从kretprobe中获取函数入参</p>
<p> kretprobe获取函数入参，使用<code>ctx-&gt;bx</code></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int kretprobe__tcp_set_state(structpt_regs*ctx)&#123;</span><br><span class="line">struct sock*sk=(void*)ctx-&gt;bx;</span><br><span class="line">u16 dport = sk-&gt;__sk_common.skc_dport;</span><br><span class="line">dport = ntohs(dport);</span><br><span class="line">u16 sport=sk-&gt;__sk_common.skc_num;</span><br><span class="line">u32 daddr=sk-&gt;__sk_common.skc_daddr;</span><br><span class="line">u32 saddr=sk-&gt;__sk_common.skc_rcv_saddr;</span><br><span class="line">if(sport == 8087 || dport==8087)&#123;</span><br><span class="line">    u32 state=(u32)ctx-&gt;cx;</span><br><span class="line">    bpf_trace_printk(&quot;sport %d dport %d state %d\n&quot;,sport,dport,state);</span><br><span class="line">&#125;</span><br><span class="line">return0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 但是，目前只能获取第一个参数，第二个参数用ctx-&gt;cx无法获取（虽然不报错）</p>
<p> 注：问了社区的人，ctx-&gt;bx这种做法也是不保证对的，这里能获取到有一定的lucky成份</p>
</li>
<li><p>获取当前进程cgroup path</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">task = (struct task_struct *)bpf_get_current_task();</span><br><span class="line">u32 nr_tasks = task-&gt;cgroups-&gt;nr_tasks;</span><br><span class="line">char name[100];</span><br><span class="line">char path[100];</span><br><span class="line">u32 readn = bpf_probe_read_str(&amp;name, sizeof(name), task-&gt;sched_task_group-&gt;css.cgroup-&gt;kn-&gt;name);</span><br><span class="line">if (task-&gt;sched_task_group-&gt;css.cgroup-&gt;kn-&gt;parent) &#123;</span><br><span class="line">u32 len = bpf_probe_read_str(&amp;path, sizeof(path), task-&gt;sched_task_group-&gt;css.cgroup-&gt;kn-&gt;parent-&gt;name);</span><br><span class="line">if (len &gt; 3) &#123;</span><br><span class="line">    if (path[0]==&apos;p&apos; &amp;&amp; path[1]==&apos;o&apos;&amp;&amp;path[2]==&apos;d&apos;) &#123;</span><br><span class="line">        // this is a pod</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>遇到有些struct并没有出自linux标准header定义里，需要自己在代码里伪造一个</p>
<p> 例如上例中的<code>sched_task_group-&gt;css</code>, 需要自己定义：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct task_group &#123;</span><br><span class="line">    struct cgroup_subsys_state css;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>再谈 kretprobe</p>
<p> 关于获取kretprobe的方式，一般是配合kprobe使用，在kprobe中用pid_tgid作为key来存储信息，在kretprobe中用pid_tgid来取出信息；这里的疑问是，比如在go的GPM调度模型中G(goroutine)是可以跨M调度的，如果当前G在M中执行时，在执行到kprobe存储信息之后，由于时间片已消耗被linux调度器抢占执行其他线程，那么恢复goroutine执行逻辑的时候可能已经跑到别的M上执行了，此时在执行kretprobe的时候，pid_tgid会发生变化。或者还有一种情况，在M重新被调度指挥，go的调度器此时会另一个goroutine来执行，此时如果也触发了kprobe, 相对于再次存储，覆盖了刚才存储的信息。</p>
</li>
<li><p>map空间问题</p>
<p> bcc下bpf map有默认值，有时候需要注意下是否足够，例如我之前用BPF_HASH来记录tcp连接情况，可能默认的10240是不够的</p>
</li>
</ol>
</div><div class="tags"><a href="/tags/kernel/">kernel</a><a href="/tags/ebpf/">ebpf</a></div><div class="post-nav"><a class="next" href="/2020/01/19/ebpf-sockhash-debug/">ebpf/sockhash 内核bug定位分析</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://chenlingpeng.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-System/">Distributed System</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/lang/">lang</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/neural-network/" style="font-size: 15px;">neural network</a> <a href="/tags/others/" style="font-size: 15px;">others</a> <a href="/tags/algorithm/" style="font-size: 15px;">algorithm</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kubelet/" style="font-size: 15px;">kubelet</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/calico/" style="font-size: 15px;">calico</a> <a href="/tags/tc/" style="font-size: 15px;">tc</a> <a href="/tags/lang/" style="font-size: 15px;">lang</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/ebpf/" style="font-size: 15px;">ebpf</a> <a href="/tags/tcpdump/" style="font-size: 15px;">tcpdump</a> <a href="/tags/Distributed-System/" style="font-size: 15px;">Distributed System</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/ebpf-code-skill/">ebpf code skill</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/19/ebpf-sockhash-debug/">ebpf/sockhash 内核bug定位分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/08/linux-kernel-build-and-submit-patch/">linux 内核源码修改编译与patch提交</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/07/ebpf-intro/">ebpf intro</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/23/k8s-service-ip-problem/">k8s service ip problem</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/04/k8s-floatingip-evolution/">k8s floatingip evolution</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/22/sriov-getting-start/">sriov getting start</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/18/ipvs-attempt/">ipvs attempt</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/30/iptables-quick-start/">iptables quick start</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/16/calico-getting-start/">calico getting start</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">chenlingpeng.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>