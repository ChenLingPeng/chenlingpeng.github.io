<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Developer in Tencent"><title>linux 内核源码修改编译与patch提交 | chenlingpeng</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">linux 内核源码修改编译与patch提交</h1><a id="logo" href="/.">chenlingpeng</a><p class="description">hahahaha</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">linux 内核源码修改编译与patch提交</h1><div class="post-meta">Jan 8, 2020</div><div class="post-content"><blockquote>
<p>最近在写bpf/sockmap的时候发现一个sockhash的内核bug，经过一系列定位后终于找到了问题代码并修复，最后将修复的patch提交到了社区。这是第一次向linux kernel提交代码，在这里记录一下~</p>
</blockquote>
<h1 id="linux内核编译"><a href="#linux内核编译" class="headerlink" title="linux内核编译"></a>linux内核编译</h1><p>首先需要准备一下编译环境</p>
<p><code>apt-get install git fakeroot build-essential ncurses-dev xz-utils libssl-dev bc flex libelf-dev bison</code></p>
<p>接下来获取源码进行修改，如果只是在某个版本修改代码且不提交到linux社区，可以直接从<a href="http://cdn.kernel.org/pub/linux/kernel/" target="_blank" rel="noopener">这里</a>下载源码，这个比git clone会快很多。如果希望代码修改后能反馈到社区，则可以<code>git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git</code>获取最新代码</p>
<p>进入linux源码目录后，好需要拷贝一份内核配置文件： <code>cp /boot/config-5.0.0-36-generic .config</code></p>
<p>然后可以通过命令<code>make menuconfig</code>在图形化界面选择一些配置项，一般我们直接保存退出就可以了。</p>
<p>接下来进行编译，很简单，直接<code>make -j $(nproc)</code>进行多核编译，加快编译速度</p>
<p>编译完成后安装内核模块 <code>make modules_install</code></p>
<p>然后安装内核本身 <code>make install</code></p>
<p>最后还需要更新grub 启动项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo update-initramfs -c -k 5.5.0-rc5</span><br><span class="line">$ sudo update-grub</span><br></pre></td></tr></table></figure>
<p>最后的最后reboot重启机器，<code>uname -r</code>就可以看到是最新的内核版本了</p>
<h1 id="提交patch"><a href="#提交patch" class="headerlink" title="提交patch"></a>提交patch</h1><ol>
<li><p>新建一个分支 <code>git checkout -t -b fix_sockhash master</code></p>
</li>
<li><p>在新分支上修改代码。</p>
</li>
<li><p>生成commit: git commit -s -v。此时会弹出编辑器，需要编辑commit message。</p>
<p> commit message需要按照一定的格式，首行需要按照格式<code>&lt;subsystem&gt;/&lt;sub-subsystem&gt;: &lt;descriptive comment&gt;</code> 这样在<code>git log --oneline</code>的时候看的更清晰<br> 然后空一行，然后具体描述这个commit做了什么。由于git commit时我们加上了-s参数，所以commit message里可以看到最后有<code>Signed-off-by</code> ，也就是作者的签名。如果此path是一个bug-fix, 在此之上最好能附上Fixes tag例如：<code>Fixes: 604326b41a6fb (&quot;bpf, sockmap: convert to generic sk_msg interface&quot;)</code></p>
<p> 以下是一个完整的commit message 示例</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bpf/sockmap: read psock ingress_msg before sk_receive_queue</span><br><span class="line"></span><br><span class="line">Right now in tcp_bpf_recvmsg, sock read data first from sk_receive_queue</span><br><span class="line">if not empty than psock-&gt;ingress_msg otherwise. If a FIN packet arrives</span><br><span class="line">and there&apos;s also some data in psock-&gt;ingress_msg, the data in</span><br><span class="line">psock-&gt;ingress_msg will be purged. It is always happen when request to a</span><br><span class="line">HTTP1.0 server like python SimpleHTTPServer since the server send FIN</span><br><span class="line">packet after data is sent out.</span><br><span class="line"></span><br><span class="line">Fixes: 604326b41a6fb (&quot;bpf, sockmap: convert to generic sk_msg interface&quot;)</span><br><span class="line">Reported-by: Arika Chen &lt;eaglesora@gmail.com&gt;</span><br><span class="line">Suggested-by: Arika Chen &lt;eaglesora@gmail.com&gt;</span><br><span class="line">Signed-off-by: Lingpeng Chen &lt;forrest0579@gmail.com&gt;</span><br><span class="line">Signed-off-by: John Fastabend &lt;john.fastabend@gmail.com&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后使用脚本生成patch <code>git format-patch master</code>，或者 <code>git format-patch HEAD~&lt;number of commits to convert to patches&gt;</code> 。</p>
</li>
<li><p>检查patch是否有问题并修复： <code>./scripts/checkpatch.pl 0001-xxx.patch</code>。没啥问题就可以准备发邮件给社区review了。</p>
</li>
<li><p>接下来就是发送邮件给社区，建议使用 <code>git send-email</code> 功能来发送(需要安装git-email <code>apt install git-email -y</code>)</p>
<p> 首先需要配置一下email的配置信息，编辑<code>~/.gitconfig</code>输入相关邮箱信息，例如gmail的配置如下：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.gitconfig:</span><br><span class="line">[user]</span><br><span class="line">	name = Lingpeng Chen</span><br><span class="line">	email = myemail@gmail.com</span><br><span class="line"></span><br><span class="line">[sendemail]</span><br><span class="line">	from = Lingpeng Chen &lt;myemail@gmail.com&gt;</span><br><span class="line">	smtpserver = smtp.gmail.com</span><br><span class="line">	smtpuser = myemail@gmail.com</span><br><span class="line">	smtpencryption = tls</span><br><span class="line">	smtppass = mypassword</span><br><span class="line">	chainreplyto = false</span><br><span class="line">	smtpserverport = 587</span><br></pre></td></tr></table></figure>
<p> 这里需要设置smtppass，google账号一般开启了<code>2-Step 验证</code>，所以直接使用账号的密码可能会发送失败，此时需要进入 <code>account-&gt;security-&gt;app-passwords</code>里面创建一个新的<a href="https://myaccount.google.com/apppasswords" target="_blank" rel="noopener">应用密码</a>。</p>
<p> 配置完后可以发送邮件 <code>git send-email --to &quot;forrest0579 &lt;forrest0579@gmail.com&gt;&quot; --cc &quot;lingpeng chen &lt;cc@example.com&gt;&quot; 0001-xxx.patch</code> 可以先往自己的邮箱里面发送看看效果。</p>
<p> 如果没啥问题，我们再往社区发。这里需要给相关的maintainer和一些邮件组发，可以通过脚本来获取，例如：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ ./scripts/get_maintainer.pl 0001-bpf-sockmap-read-psock-ingress_msg-before-sk_receive.patch </span><br><span class="line">Eric Dumazet &lt;edumazet@google.com&gt; (maintainer:NETWORKING [TCP])</span><br><span class="line">John Fastabend &lt;john.fastabend@gmail.com&gt; (maintainer:L7 BPF FRAMEWORK,blamed_fixes:1/1=100%)</span><br><span class="line">Daniel Borkmann &lt;daniel@iogearbox.net&gt; (maintainer:L7 BPF FRAMEWORK,blamed_fixes:1/1=100%)</span><br><span class="line">&quot;David S. Miller&quot; &lt;davem@davemloft.net&gt; (maintainer:NETWORKING [IPv4/IPv6])</span><br><span class="line">Alexey Kuznetsov &lt;kuznet@ms2.inr.ac.ru&gt; (maintainer:NETWORKING [IPv4/IPv6])</span><br><span class="line">Hideaki YOSHIFUJI &lt;yoshfuji@linux-ipv6.org&gt; (maintainer:NETWORKING [IPv4/IPv6])</span><br><span class="line">Alexei Starovoitov &lt;ast@kernel.org&gt; (supporter:BPF (Safe dynamic programs and tools),blamed_fixes:1/1=100%)</span><br><span class="line">Martin KaFai Lau &lt;kafai@fb.com&gt; (reviewer:BPF (Safe dynamic programs and tools))</span><br><span class="line">Song Liu &lt;songliubraving@fb.com&gt; (reviewer:BPF (Safe dynamic programs and tools))</span><br><span class="line">Yonghong Song &lt;yhs@fb.com&gt; (reviewer:BPF (Safe dynamic programs and tools))</span><br><span class="line">Andrii Nakryiko &lt;andriin@fb.com&gt; (reviewer:BPF (Safe dynamic programs and tools))</span><br><span class="line">netdev@vger.kernel.org (open list:NETWORKING [TCP])</span><br><span class="line">bpf@vger.kernel.org (open list:L7 BPF FRAMEWORK)</span><br><span class="line">linux-kernel@vger.kernel.org (open list)</span><br></pre></td></tr></table></figure>
<p> 挑选一些人作为收件对象然后发送邮件。</p>
</li>
<li><p>更新patch<br> 社区的人review之后可能会给出一些意见，修改后还可以使用send-email来回复。此时需要使用<code>--in-reply-to</code>来指定回复哪封邮件，邮件的ID可以在邮箱里查看邮件信息看到。例如gmail里可以通过 <strong>显示原始邮件</strong> 得到邮件ID。另外，更新的patch可以使用 <code>git format-patch -v2</code>来指定更新的版本号，方便大家review。</p>
</li>
</ol>
<p>最后，<a href="http://vger.kernel.org/vger-lists.html" target="_blank" rel="noopener">http://vger.kernel.org/vger-lists.html</a> 这个网址可以看到各个子系统的邮件组信息。发送完后这里会显示你新发的邮件</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://www.cyberciti.biz/tips/compiling-linux-kernel-26.html" target="_blank" rel="noopener">https://www.cyberciti.biz/tips/compiling-linux-kernel-26.html</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/process/submitting-patches.html" target="_blank" rel="noopener">https://www.kernel.org/doc/html/latest/process/submitting-patches.html</a></li>
<li><a href="http://nickdesaulniers.github.io/blog/2017/05/16/submitting-your-first-patch-to-the-linux-kernel-and-responding-to-feedback/" target="_blank" rel="noopener">http://nickdesaulniers.github.io/blog/2017/05/16/submitting-your-first-patch-to-the-linux-kernel-and-responding-to-feedback/</a></li>
</ol>
</div><div class="tags"><a href="/tags/kernel/">kernel</a></div><div class="post-nav"><a class="pre" href="/2020/01/19/ebpf-sockhash-debug/">ebpf/sockhash 内核bug定位分析</a><a class="next" href="/2020/01/07/ebpf-intro/">ebpf intro</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://chenlingpeng.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Distributed-System/">Distributed System</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/lang/">lang</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/neural-network/" style="font-size: 15px;">neural network</a> <a href="/tags/others/" style="font-size: 15px;">others</a> <a href="/tags/algorithm/" style="font-size: 15px;">algorithm</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kubelet/" style="font-size: 15px;">kubelet</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/calico/" style="font-size: 15px;">calico</a> <a href="/tags/tc/" style="font-size: 15px;">tc</a> <a href="/tags/lang/" style="font-size: 15px;">lang</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/ebpf/" style="font-size: 15px;">ebpf</a> <a href="/tags/tcpdump/" style="font-size: 15px;">tcpdump</a> <a href="/tags/Distributed-System/" style="font-size: 15px;">Distributed System</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/08/13/ebpf-code-skill/">ebpf code skill</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/19/ebpf-sockhash-debug/">ebpf/sockhash 内核bug定位分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/08/linux-kernel-build-and-submit-patch/">linux 内核源码修改编译与patch提交</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/07/ebpf-intro/">ebpf intro</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/23/k8s-service-ip-problem/">k8s service ip problem</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/04/k8s-floatingip-evolution/">k8s floatingip evolution</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/22/sriov-getting-start/">sriov getting start</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/18/ipvs-attempt/">ipvs attempt</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/30/iptables-quick-start/">iptables quick start</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/16/calico-getting-start/">calico getting start</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">chenlingpeng.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>